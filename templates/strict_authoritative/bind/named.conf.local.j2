// BIND 9 Configuration - named.conf.local - generated by systemli.bind9 ansible role
// DO NOT edit, change your ansible config and re-run your ansible playbooks
//

// Consider adding the 1918 zones here, if they are not used in your
// organization
//include "/etc/bind/zones.rfc1918";

{% if bind9_statistics_enabled %}

statistics-channels {
  inet 127.0.0.1 port 8053 allow { 127.0.0.1; };
};
{% endif %}
{% if bind9_masters is defined or bind9_masters_extra is defined %}

// masters clause lists for masters secondary zones and also-notify statements
// and ACLs with same name and content, to be used in allow-transfer statements
{%   for master in bind9_masters | default ([]) + bind9_masters_extra | default ([]) %}
masters {{ master.name }} {
{%     for addr in master.addresses %}
    {{ addr }};
{%     endfor %}
};
acl {{ master.name }} {
{%     for addr in master.addresses %}
    {{ addr }};
{%     endfor %}
};

{%   endfor %}
{% endif %}
{% if bind9_acl is defined %}

	// Custom acls
{%   for acl_item in bind9_acl %}
acl {{ acl_item.name }} {
{%     for acl_address in acl_item.addresses %}
	{{ acl_address }};
{%     endfor %}
};
{%   endfor %}
{% endif %}

// The following zones are managed by this DNS Server //
{% for zone in ( bind9_zones_static + bind9_zones_dynamic ) | sort( attribute='name' ) %}
{%   set zone_type = zone.type | default( bind9_zone_type | default( 'master' ) ) %}
zone "{{ zone.name }}" {
    type {{ zone_type }};
{# ############################### Type zone specific statements ####################################### #}
{%   if zone_type == 'master' %}
    file "/etc/bind/zones/db.{{ zone.name }}";
{%   elif zone_type == 'slave' %}
    file "/var/lib/bind/db.{{ zone.name }}";
{%     if zone.masters is defined or bind9_masters is defined %}
    masters {
{%       if zone.masters is defined %}
{%         for master in zone.masters %}
        {{ master }};
{%         endfor %}
{%       else  %} {# so bind9_masters is defined #}
{%         for master in bind9_masters %}
        {{ master.name }};
{%         endfor %}
{%       endif %}
    };
{%     endif %}
{%   elif zone_type == 'forward' %}
    forwarders {
{%     for fwd in zone.forwarders %}
        {{ fwd }}; 
{%     endfor %}
   }; 
{%   endif %}
{# ############################### Common statements to all zone types ####################################### #}
    allow-query {
{%   if zone.allow_query is defined and zone.allow_query | length() > 0  %}
{%     for allow_query_item in zone.allow_query | list %}
        {{ allow_query_item }};
{%     endfor %}
    };
{%   else %}
        any;
    };
{%   endif %}
{%   if zone.notify is defined %}
     notify {{ zone.notify }};
{%   endif %}
{%   set zone_also_notify = zone.also_notify | default( bind9_also_notify | default( [] ) ) %}
{%   if zone.also_notify is defined and zone.also_notify | length() > 0 %}
    also-notify {
{%     for also_notify_item in zone.also_notify | list %}
        {{ also_notify_item }};
{%     endfor %}
    };
{%   endif %}
{%   set zone_also_allow_transfer = zone.also_allow_transfer | default( bind9_also_allow_transfer | default( [] ) ) %}
{# ############################### Primary zones must consider secundaries ########################################### #}
{%   if zone_type == 'master' %}
{%     set zone_calc_allow_transfer = zone.slaves | default( bind9_slaves | default( [] ) ) | union( zone_also_notify | union ( zone_also_allow_transfer ) ) %}
{%   else %}
{%     set zone_calc_allow_transfer =  zone_also_notify | union( zone_also_allow_transfer ) %}
{%   endif %}
{%   set zone_allow_transfer = zone.allow_transfer | default ( bind9_allow_transfer | default( ( zone_calc_allow_transfer ) | unique ) ) %}
{%   if zone_allow_transfer | length > 0 %}

    // allow transfer from secundaries, also-notify hosts and other allow-transfer specified
    allow-transfer {
{%     for allow_transfer_item in zone_allow_transfer %}
        {{ allow_transfer_item }};
{%     endfor %}
    };
{%   endif %}
{# ############################### Primary zones are concerned by dnssec ########################################### #}
{%   if zone_type == 'master' %}
{%     if ( bind9_dnssec or zone.dnssec | default() ) and zone.dnssec | default( bind9_dnssec_zones_default_enabled ) %}
    auto-dnssec maintain;
    inline-signing yes;
{%     endif %}
{%     if zone.update_policy_grant | default() %}
    update-policy {
        grant {{ zone.name }}_ddns_update {{ zone.update_policy_grant }};
    };
{%     endif %}
{%   endif %}
};
{% endfor %}